
!!!!!!!!!!!!!!!!!!!!!!!!!!基于COLE-COLE模型的电性源TEM一维正演!!!!!!!!!!!!!!!!!!!!!!!


!=================================================================================
!    以下部分为模块定义
!=================================================================================
MODULE CONSTANTS
   REAL*8,PARAMETER::PI=3.1415926D0
   REAL*8,PARAMETER::MIU0=4.D-7*PI
   INTEGER,PARAMETER::NH0=301    !0阶汉克尔系数个数
   INTEGER,PARAMETER::NH1=301    !1阶汉克尔系数个数
   INTEGER,PARAMETER::NH05=160   !0.5阶汉克尔系数个数
   INTEGER,PARAMETER::NG=7       !高斯积分点数
END MODULE
!================================================================================
MODULE GAUSS
   USE CONSTANTS
   REAL*8::X(NG),W(NG)   !高斯积分点和高斯积分系数          
END MODULE
!===============================================================================
MODULE HANKERL
   USE CONSTANTS
   REAL*8 :: H0(NH0),H1(NH1),H05(NH05) !汉克尔变换系数
	DATA H0(1:NH0)/ &
       2.30258509299403D-16, 2.89878288638864D-16, 3.64935143894870D-16,&
       4.59426126306012D-16, 5.78383225248795D-16, 7.28141340021177D-16,&
       9.16675636330517D-16, 1.15402625294907D-15, 1.45283297571520D-15,&
       1.82900835222041D-15, 2.30258509299404D-15, 2.89878288638863D-15,&
       3.64935143894869D-15, 4.59426126306013D-15, 5.78383225248796D-15,&
       7.28141340021178D-15, 9.16675636330518D-15, 1.15402625294908D-14,&
       1.45283297571520D-14, 1.82900835222040D-14, 2.30258509299404D-14,&
       2.89878288638864D-14, 3.64935143894870D-14, 4.59426126306012D-14,&
       5.78383225248797D-14, 7.28141340021179D-14, 9.16675636330519D-14,&
       1.15402625294908D-13, 1.45283297571520D-13, 1.82900835222040D-13,&
       2.30258509299404D-13, 2.89878288638863D-13, 3.64935143894870D-13,&
       4.59426126306012D-13, 5.78383225248796D-13, 7.28141340021178D-13,&
       9.16675636330523D-13, 1.15402625294907D-12, 1.45283297571520D-12,&
       1.82900835222039D-12, 2.30258509299406D-12, 2.89878288638860D-12,&
       3.64935143894873D-12, 4.59426126306006D-12, 5.78383225248807D-12,&
       7.28141340021160D-12, 9.16675636330549D-12, 1.15402625294904D-11,&
       1.45283297571527D-11, 1.82900835222029D-11, 2.30258509299422D-11,&
       2.89878288638835D-11, 3.64935143894914D-11, 4.59426126305941D-11,&
       5.78383225248909D-11, 7.28141340021001D-11, 9.16675636330801D-11,&
       1.15402625294863D-10, 1.45283297571591D-10, 1.82900835221928D-10,&
       2.30258509299582D-10, 2.89878288638581D-10, 3.64935143895317D-10,&
       4.59426126305303D-10, 5.78383225249919D-10, 7.28141340019398D-10,&
       9.16675636333344D-10, 1.15402625294460D-09, 1.45283297572230D-09,&
       1.82900835220916D-09, 2.30258509301186D-09, 2.89878288636039D-09,&
       3.64935143899346D-09, 4.59426126298919D-09, 5.78383225260039D-09,&
       7.28141340003359D-09, 9.16675636358762D-09, 1.15402625290432D-08,&
       1.45283297578614D-08, 1.82900835210798D-08, 2.30258509317224D-08,&
       2.89878288610622D-08, 3.64935143939630D-08, 4.59426126235073D-08,&
       5.78383225361227D-08, 7.28141339842988D-08, 9.16675636612933D-08,&
       1.15402625250149D-07, 1.45283297642459D-07, 1.82900835109610D-07,&
       2.30258509477595D-07, 2.89878288356450D-07, 3.64935144342465D-07,&
       4.59426125596622D-07, 5.78383226373104D-07, 7.28141338239271D-07,&
       9.16675639154654D-07, 1.15402624847313D-06, 1.45283298280911D-06,&
       1.82900834097732D-06, 2.30258511081313D-06, 2.89878285814729D-06,&
       3.64935148370823D-06, 4.59426119212106D-06, 5.78383236491881D-06,&
       7.28141322202092D-06, 9.16675664571870D-06, 1.15692568635141D-05,&
       1.45087827351971D-05, 1.82530641973561D-05, 2.30329093159017D-05,&
       2.90287571882358D-05, 3.65008256307404D-05, 4.59026901030200D-05,&
       5.78164379419823D-05, 7.28478000065234D-05, 9.17024805846445D-05,&
       1.15380000226873D-04, 1.45238834894431D-04, 1.82908228502699D-04,&
       2.30307873270612D-04, 2.89887792454861D-04, 3.64887377803399D-04,&
       4.59397200620795D-04, 5.78423721936644D-04, 7.28181542633835D-04,&
       9.16648402487170D-04, 1.15395875282585D-03, 1.45283308780011D-03,&
       1.82902990494560D-03, 2.30256008248954D-03, 2.89857991498878D-03,&
       3.64912928720313D-03, 4.59378273753700D-03, 5.78309102578837D-03,&
       7.27938387170171D-03, 9.16333272186852D-03, 1.15325744795914D-02,&
       1.45146650014459D-02, 1.82601452272593D-02, 2.29700255283581D-02,&
       2.88702043418760D-02, 3.62692440469273D-02, 4.54794903475425D-02,&
       5.69407846225404D-02, 7.09871978329290D-02, 8.80995368691852D-02,&
       1.08224007793146D-01, 1.31250538187391D-01, 1.55055605753986D-01,&
       1.76371397854097D-01, 1.85627814446814D-01, 1.69778199522253D-01,&
       1.03405228464647D-01,-3.02585080852413D-02,-2.27574462293652D-01,&
      -3.62173038933215D-01,-2.05500274117075D-01, 3.37394760195314D-01,&
       3.17689637576683D-01,-5.13762181990569D-01, 3.09130540155790D-01,&
      -1.26757397548834D-01, 4.61966182048520D-02,-1.80971728957747D-02,&
       8.35424027057190D-03,-4.47340689899017D-03, 2.61992284481349D-03,&
      -1.60186527593784D-03, 9.97487568736810D-04,-6.26255324679473D-04,&
       3.94547305739130D-04,-2.48532137821463D-04, 1.56659377774707D-04,&
      -9.90528420086167D-05, 6.24951030522875D-05,-3.92380367944152D-05,&
       2.48316425706516D-05,-1.58101814991317D-05, 9.85592094149573D-06,&
      -6.13544872004916D-06, 4.00934598819861D-06,-2.55461486714110D-06,&
       1.47749188535257D-06,-9.57845189423385D-07, 7.18083810567243D-07,&
      -3.89102220100711D-07, 1.63476698770087D-07,-1.91211696957178D-07,&
       1.65602216023964D-07,-6.91689649529385D-09,-3.29252673136464D-09,&
      -9.16461597786438D-08, 3.22668612246087D-08,-9.89180887451364D-09,&
       6.24130945956812D-09,-3.93800004268785D-09, 2.48471004949759D-09,&
      -1.56774605463391D-09, 9.89180887451260D-10,-6.24130945956750D-10,&
       3.93800004268844D-10,-2.48471004949674D-10, 1.56774605463395D-10,&
      -9.89180887451288D-11, 6.24130945956768D-11,-3.93800004268852D-11,&
       2.48471004949741D-11,-1.56774605463399D-11, 9.89180887451071D-12,&
      -6.24130945956782D-12, 3.93800004268766D-12,-2.48471004949748D-12,&
       1.56774605463403D-12,-9.89180887451090D-13, 6.24130945956798D-13,&
      -3.93800004268776D-13, 2.48471004949753D-13,-1.56774605463407D-13,&
       9.89180887451366D-14,-6.24130945956817D-14, 3.93800004268788D-14,&
      -2.48471004949760D-14, 1.56774605463449D-14,-9.89180887451387D-15,&
       6.24130945956979D-15,-3.93800004268890D-15, 2.48471004949765D-15,&
      -1.56774605463414D-15, 9.89180887451653D-16,-6.24130945956999D-16,&
       3.93800004268903D-16,-2.48471004949773D-16, 1.56774605463456D-16,&
      -9.89180887451434D-17, 6.24130945956860D-17,-3.93800004269009D-17,&
       2.48471004949901D-17,-1.56774605463499D-17, 9.89180887451950D-18,&
      -6.24130945957493D-18, 3.93800004269214D-18,-2.48471004949846D-18,&
       1.56774605463465D-18,-9.89180887451971D-19, 6.24130945957199D-19,&
      -3.93800004269029D-19, 2.48471004949975D-19,-1.56774605463547D-19,&
       9.89180887452002D-20,-6.24130945957219D-20, 3.93800004269233D-20,&
      -2.48471004949981D-20, 1.56774605463551D-20,-9.89180887452028D-21,&
       6.24130945957232D-21,-3.93800004269050D-21, 2.48471004949866D-21,&
      -1.56774605463555D-21, 9.89180887452049D-22,-6.24130945957251D-22,&
       3.93800004269060D-22,-2.48471004949994D-22, 1.56774605463558D-22,&
      -9.89180887452080D-23, 6.24130945957264D-23,-3.93800004269264D-23,&
       2.48471004949879D-23,-1.56774605463485D-23, 9.89180887452101D-24,&
      -6.24130945957278D-24, 3.93800004269081D-24,-2.48471004949884D-24,&
       1.56774605463566D-24,-9.89180887452122D-25, 6.24130945957303D-25,&
      -3.93800004269093D-25, 2.48471004950012D-25,-1.56774605463571D-25,&
       9.89180887452152D-26,-6.24130945957316D-26, 3.93800004269101D-26,&
      -2.48471004949899D-26, 1.56774605463498D-26,-9.89180887452173D-27,&
       6.24130945957330D-27,-3.93800004269110D-27, 2.48471004949904D-27,&
      -1.56774605463579D-27, 9.89180887452214D-28,-6.24130945957349D-28,&
       3.93800004269126D-28,-2.48471004949789D-28, 1.56774605463505D-28,&
      -9.89180887451743D-29, 6.24130945957052D-29,-3.93800004268938D-29,&
       2.48471004949794D-29,-1.56774605463433D-29, 9.89180887451283D-30,&
      -6.24130945957375D-30/
DATA H1(1:NH1)/ &
       1.13588466232775D-31, 1.84909557020443D-31, 2.85321327106096D-31,&
       4.64471807336095D-31, 7.16694770178106D-31, 1.16670043066626D-30,&
       1.80025586874425D-30, 2.93061898142696D-30, 4.52203828994423D-30,&
       7.36138205537089D-30, 1.13588466232777D-29, 1.84909557020442D-29,&
       2.85321327106095D-29, 4.64471807336096D-29, 7.16694770178108D-29,&
       1.16670043066627D-28, 1.80025586874426D-28, 2.93061898142699D-28,&
       4.52203828994421D-28, 7.36138205537085D-28, 1.13588466232776D-27,&
       1.84909557020442D-27, 2.85321327106095D-27, 4.64471807336094D-27,&
       7.16694770178109D-27, 1.16670043066627D-26, 1.80025586874426D-26,&
       2.93061898142697D-26, 4.52203828994422D-26, 7.36138205537087D-26,&
       1.13588466232776D-25, 1.84909557020441D-25, 2.85321327106096D-25,&
       4.64471807336095D-25, 7.16694770178106D-25, 1.16670043066627D-24,&
       1.80025586874427D-24, 2.93061898142698D-24, 4.52203828994420D-24,&
       7.36138205537088D-24, 1.13588466232777D-23, 1.84909557020442D-23,&
       2.85321327106094D-23, 4.64471807336096D-23, 7.16694770178107D-23,&
       1.16670043066627D-22, 1.80025586874427D-22, 2.93061898142699D-22,&
       4.52203828994421D-22, 7.36138205537085D-22, 1.13588466232777D-21,&
       1.84909557020442D-21, 2.85321327106095D-21, 4.64471807336094D-21,&
       7.16694770178109D-21, 1.16670043066627D-20, 1.80025586874426D-20,&
       2.93061898142699D-20, 4.52203828994422D-20, 7.36138205537086D-20,&
       1.13588466232776D-19, 1.84909557020442D-19, 2.85321327106096D-19,&
       4.64471807336094D-19, 7.16694770178106D-19, 1.16670043066627D-18,&
       1.80025586874427D-18, 2.93061898142698D-18, 4.52203828994423D-18,&
       7.36138205537088D-18, 1.13588466232776D-17, 1.84909557020441D-17,&
       2.85321327106096D-17, 4.64471807336096D-17, 7.16694770178107D-17,&
       1.16670043066627D-16, 1.80025586874427D-16, 2.93061898142699D-16,&
       4.52203828994421D-16, 7.36138205537090D-16, 1.13588466232777D-15,&
       1.84909557020442D-15, 2.85321327106097D-15, 4.64471807336097D-15,&
       7.16694770178111D-15, 1.16670043066627D-14, 1.80025586874427D-14,&
       2.93061898142700D-14, 4.52203828994423D-14, 7.36138205537091D-14,&
       1.13588466232777D-13, 1.84909557020443D-13, 2.85321327106097D-13,&
       4.64471807336098D-13, 7.16694770178110D-13, 1.16670043066628D-12,&
       1.80025586874427D-12, 2.93061898142700D-12, 4.52203828994424D-12,&
       7.36138205537090D-12, 1.13588466232777D-11, 1.84909557020443D-11,&
       2.85321327106097D-11, 4.64471807336097D-11, 7.16694770178112D-11,&
       1.16670043066627D-10, 1.80025586874428D-10,-2.36788869548338D-08,&
      -3.34475141166181D-08, 1.34870873828571D-08, 4.08385473343560D-08,&
       2.80121976514437D-09,-3.80302709879098D-08,-1.09746179621941D-08,&
       4.40835037014508D-08, 4.11565840080884D-08,-9.85920070296272D-09,&
      -1.14412869949359D-08, 5.96273408981848D-08, 1.21347401070404D-07,&
       1.15746143593174D-07, 1.35755137670835D-07, 2.65285400213762D-07,&
       5.08740713912392D-07, 7.53780468129344D-07, 1.13366704055012D-06,&
       1.74921480162424D-06, 2.94678050152096D-06, 4.58175245070243D-06,&
       7.36613577570292D-06, 1.12972894502548D-05, 1.84628814870215D-05,&
       2.85861497878519D-05, 4.64946994202422D-05, 7.16237744109514D-05,&
       1.16587618266200D-04, 1.80006697243418D-04, 2.93050475810005D-04,&
       4.51987234629232D-04, 7.35484357606847D-04, 1.13440284010395D-03,&
       1.84555415559067D-03, 2.84421704926730D-03, 4.62189906476383D-03,&
       7.10970555942942D-03, 1.15237043776898D-02, 1.76435641387987D-02,&
       2.84076556045201D-02, 4.29769445157177D-02, 6.80331730038758D-02,&
       9.97846861084994D-02, 1.51070679020061D-01, 2.03540534518256D-01,&
       2.71235203507808D-01, 2.76073843274538D-01, 2.16692162759385D-01,&
      -7.83722496525276D-02,-3.40675776800532D-01,-3.60693896284711D-01,&
       5.13024574160905D-01,-5.94721924294170D-02,-1.95117008425594D-01,&
       1.99235364397954D-01,-1.38521821446553D-01, 8.79321576119434D-02,&
      -5.50694068838152D-02, 3.45638999530987D-02,-2.17529336450324D-02,&
       1.37098107412830D-02,-8.64648647769419D-03, 5.45485444156662D-03,&
      -3.44135145524447D-03, 2.17112709073384D-03,-1.37009501223577D-03,&
       8.64510640210768D-04,-5.45257776035130D-04, 3.44079400552110D-04,&
      -2.17267214354118D-04, 1.36982454493871D-04,-8.63196031805410D-05,&
       5.45979140323202D-05,-3.44991451557358D-05, 2.16281976334282D-05,&
      -1.36512898199950D-05, 8.73856143359011D-06,-5.46449722783360D-06,&
       3.35048002563884D-06,-2.19379741348718D-06, 1.44594211470428D-06,&
      -8.16683898775421D-07, 4.91549174330555D-07,-4.07505580172176D-07,&
       2.45223932571511D-07,-6.78310841537617D-08, 8.64396337400058D-08,&
      -5.45397217624348D-08, 3.44122380119146D-08,-2.17126543136179D-08,&
       1.36997587073368D-08,-8.64396337400062D-09, 5.45397217624350D-09,&
      -3.44122380119143D-09, 2.17126543136180D-09,-1.36997587073368D-09,&
       8.64396337400058D-10,-5.45397217624348D-10, 3.44122380119144D-10,&
      -2.17126543136180D-10, 1.36997587073368D-10,-8.64396337400064D-11,&
       5.45397217624350D-11,-3.44122380119146D-11, 2.17126543136179D-11,&
      -1.36997587073368D-11, 8.64396337400066D-12,-5.45397217624345D-12,&
       3.44122380119144D-12,-2.17126543136179D-12, 1.36997587073368D-12,&
      -8.64396337400058D-13, 5.45397217624348D-13,-3.44122380119146D-13,&
       2.17126543136178D-13,-1.36997587073367D-13, 8.64396337400058D-14,&
      -5.45397217624343D-14, 3.44122380119143D-14,-2.17126543136179D-14,&
       1.36997587073368D-14,-8.64396337400050D-15, 5.45397217624343D-15,&
      -3.44122380119144D-15, 2.17126543136180D-15,-1.36997587073366D-15,&
       8.64396337400054D-16,-5.45397217624345D-16, 3.44122380119141D-16,&
      -2.17126543136178D-16, 1.36997587073367D-16,-8.64396337400058D-17,&
       5.45397217624335D-17,-3.44122380119138D-17, 2.17126543136178D-17,&
      -1.36997587073367D-17, 8.64396337400054D-18,-5.45397217624345D-18,&
       3.44122380119144D-18,-2.17126543136175D-18, 1.36997587073365D-18,&
      -8.64396337400050D-19, 5.45397217624343D-19,-3.44122380119140D-19,&
       2.17126543136177D-19,-1.36997587073367D-19, 8.64396337400058D-20,&
      -5.45397217624340D-20, 3.44122380119141D-20,-2.17126543136178D-20,&
       1.36997587073365D-20,-8.64396337400054D-21, 5.45397217624343D-21,&
      -3.44122380119144D-21, 2.17126543136175D-21,-1.36997587073365D-21,&
       8.64396337400050D-22,-5.45397217624340D-22, 3.44122380119140D-22,&
      -2.17126543136178D-22, 1.36997587073368D-22,-8.64396337400046D-23,&
       5.45397217624337D-23,-3.44122380119141D-23, 2.17126543136176D-23,&
      -1.36997587073366D-23, 8.64396337400050D-24,-5.45397217624345D-24,&
       3.44122380119143D-24,-2.17126543136174D-24, 1.36997587073365D-24,&
      -8.64396337400046D-25, 5.45397217624332D-25,-3.44122380119137D-25,&
       2.17126543136174D-25,-1.36997587073366D-25, 8.64396337400041D-26,&
      -5.45397217624340D-26, 3.44122380119139D-26,-2.17126543136178D-26,&
       1.36997587073364D-26,-8.64396337400037D-27, 5.45397217624337D-27,&
      -3.44122380119137D-27, 2.17126543136180D-27,-1.36997587073366D-27,&
       8.64396337400057D-28,-5.45397217624345D-28, 3.44122380119145D-28,&
      -2.17126543136179D-28, 1.36997587073369D-28,-8.64396337400069D-29,&
       5.45397217624337D-29/
DATA H05(1:NH05)/ &
      2.59511139938829d-13, 3.66568771323555d-13, 5.17792876616242d-13,&
      7.31400730405791d-13, 1.03313281156235d-12, 1.45933600088387d-12,&
      2.06137146234699d-12, 2.91175733962418d-12, 4.11297804457870d-12,&
      5.80971771117984d-12, 8.20647323099742d-12, 1.15919058389365d-11,&
      1.63740746547780d-11, 2.31288803930431d-11, 3.26705938902288d-11,&
      4.61481520721098d-11, 6.51864545047052d-11, 9.20775899532545d-11,&
      1.30064200980219d-10, 1.83718747396255d-10, 2.59512512377884d-10,&
      3.66566596154242d-10, 5.17796324027279d-10, 7.31395266627501d-10,&
      1.03314147106736d-09, 1.45932227649333d-09, 2.06139321404013d-09,&
      2.91172286551380d-09, 4.11303268236158d-09, 5.80963111612975d-09,&
      8.20661047490285d-09, 1.15916883220051d-08, 1.63744193958818d-08,&
      2.31283340152144d-08, 3.26714598407299d-08, 4.61467796330556d-08,&
      6.84744728867720d-08, 5.46574677490374d-08, 1.13319898777493d-07,&
      2.16529974157527d-07, 2.88629942214140d-07, 3.42872728051125d-07,&
      4.79119488706262d-07, 7.42089418889752d-07, 1.07736520535271d-06,&
      1.46383231306575d-06, 2.01727682134668d-06, 2.89058197617431d-06,&
      4.15237808867022d-06, 5.84448989361742d-06, 8.18029430348419d-06,&
      1.15420854481494d-05, 1.63897017145322d-05, 2.31769096113890d-05,&
      3.26872676331330d-05, 4.60786866701851d-05, 6.51827321351636d-05,&
      9.20862589540037d-05, 1.30169142615951d-04, 1.83587481111627d-04,&
      2.59595544393723d-04, 3.66324383719323d-04, 5.18210697462501d-04,&
      7.30729969562531d-04, 1.03385239132389d-03, 1.45738764044730d-03,&
      2.06298256402732d-03, 2.90606401578959d-03, 4.11467957883740d-03,&
      5.79034253321120d-03, 8.20005721235220d-03, 1.15193892333104d-02,&
      1.63039398900789d-02, 2.28256810984487d-02, 3.22248555163692d-02,&
      4.47865101670011d-02, 6.27330674874545d-02, 8.57058672847471d-02,&
      1.17418179407605d-01, 1.53632645832305d-01, 1.97718111895102d-01,&
      2.28849924263247d-01, 2.40310905012422d-01, 1.65409071929404d-01,&
      2.84709685167114d-03,-2.88015846269687d-01,-3.69097391853225d-01,&
     -2.50109865922601d-02, 5.71811109500426d-01,-3.92261390212769d-01,&
      7.63282774297327d-02, 5.16233692927851d-02,-6.48015160576432d-02,&
      4.89045522502552d-02,-3.26934307794750d-02, 2.10542570949745d-02,&
     -1.33862848934736d-02, 8.47098801479259d-03,-5.35134515919751d-03,&
      3.37814023806349d-03,-2.13157364002470d-03, 1.34506352474558d-03,&
     -8.48929743771803d-04, 5.35521822356713d-04,-3.37744799986382d-04,&
      2.13268792633204d-04,-1.34629969723156d-04, 8.47737416679279d-05,&
     -5.34940635827096d-05, 3.39044416298191d-05,-2.13315638358794d-05,&
      1.33440911625019d-05,-8.51629073825634d-06, 5.44362672273211d-06,&
     -3.32112278417896d-06, 2.07147190852386d-06,-1.42009412555511d-06,&
      8.78247754998004d-07,-4.55662890473703d-07, 3.38598103040009d-07,&
     -2.87407830772251d-07, 1.07866150545699d-07,-2.47240241853581d-08,&
      5.35535110396030d-08,-3.37899811131378d-08, 2.13200367531820d-08,&
     -1.34520337740075d-08, 8.48765950790546d-09,-5.35535110396018d-09,&
      3.37899811131383d-09,-2.13200367531819d-09, 1.34520337740075d-09,&
     -8.48765950790576d-10, 5.35535110396015d-10,-3.37899811131382d-10,&
      2.13200367531811d-10,-1.34520337740079d-10, 8.48765950790572d-11,&
     -5.35535110396034d-11, 3.37899811131381d-11,-2.13200367531818d-11,&
      1.34520337740074d-11,-8.48765950790571d-12, 5.35535110396031d-12,&
     -3.37899811131379d-12, 2.13200367531817d-12,-1.34520337740073d-12,&
      8.48765950790567d-13,-5.35535110396029d-13, 3.37899811131377d-13,&
     -2.13200367531816d-13, 1.34520337740078d-13,-8.48765950790596d-14,&
      5.35535110396007d-14,-3.37899811131377d-14, 2.13200367531816d-14,&
     -1.34520337740083d-14, 8.48765950790558d-15,-5.35535110396025d-15,&
      3.37899811131389d-15/
END MODULE
!=================================================================================
!--------模型参数:电阻率，厚度，极化率，时间常数，频率相关系数--------------
MODULE LAYER_PARAMETER 
   INTEGER :: N                     
   REAL*8,ALLOCATABLE :: RTH(:),H(:),MM(:),CC(:),TAO(:) 
   COMPLEX*16,ALLOCATABLE ::  RTHIP(:) 
END MODULE
!==================================================================================
MODULE FREQUENCY_FORWARD
    USE CONSTANTS
    USE LAYER_PARAMETER
    USE HANKERL
    USE GAUSS
    IMPLICIT NONE
CONTAINS
!==================================================================================
!==================================================================================
    SUBROUTINE FORWARD(X1_R,Y1_R,XS,YS,AB,I0,F,NFRE,FEX,FEY,FHX,FHY,FHZ)
    INTEGER:: NFRE,I,J
    REAL*8 :: X1_R,Y1_R,X1,Y1,XS,YS,AB,I0
    REAL*8 :: F(NFRE)
    COMPLEX*16 :: FEX(NFRE),FEY(NFRE),FHX(NFRE),FHY(NFRE),FHZ(NFRE)
    X1=X1_R-XS
    Y1=Y1_R-YS
	DO I=1,NFRE
    CALL Forward_HED(X1,Y1,AB,I0,F(I),FEX(I),FEY(I),FHX(I),FHY(I),FHZ(I))
	END DO
    END SUBROUTINE
!=================================================================================   
!===========================计算单点、单个频率域响应==============================
	SUBROUTINE Forward_HED(X1,Y1,AB,I0,F,FEX,FEY,FHX,FHY,FHZ)    
	REAL*8 :: X1,Y1,AB,I0
	REAL*8 :: M,L,RR1,RR2,F     
	COMPLEX*16 :: N1,K1F,R1,R2,A,B,IOMGA,AS
	COMPLEX*16 :: FEX0,FEX1,FEX2,FEY0,FEY1,FHX0,FHX1,FHY0,FHY1,FHY2,FHZ0
	COMPLEX*16 :: FEX,FEY,FHX,FHY,FHZ
	INTEGER :: J
	ALLOCATE(RTHIP(N)) 
	!-----------------------------------
    !--------COLE-COLE模型电阻率-------
	IOMGA=DCMPLX(0.0D0,1.0D0)*2.0D0*PI*F
	IF (F/=0.0D0) THEN
	DO J=1,N
	AS=(IOMGA*TAO(J))**CC(J)
	AS=1.0D0/(1.0D0+AS)
	AS=MM(J)*(1.0D0-AS)
    RTHIP(J)=RTH(J)*(1.0d0 - AS )    
	END DO
	ELSE
    RTHIP(J)=RTH(J)*DCMPLX(1.0D0,0.0D0)   
	END IF
	!------------------------------------
	L=AB/2.0
	K1F=-(0.D0,1.D0)*2.D0*PI*F*MIU0/RTHIP(1)
	A=-I0*RTHIP(1)/2.D0/PI  !电场前的系数（化简后的结果）
	B=I0/2./PI              !磁场前的系数
!------------------------------------------
    CALL GAULEG(-L,L,X,W,NG)
!------------------------------------------    
	RR1=DSQRT((X1-L)**2+Y1**2)      !两端点半径
	RR2=DSQRT((X1+L)**2+Y1**2)    
!------------------------------------------
!-----------计算Ex频率域响应---------------
	CALL EX_F1(X1,Y1,L,F,FEX0)
	CALL EX_F2(X1,Y1,L,F,RR2,FEX2)
	CALL EX_F2(X1,Y1,L,F,RR1,FEX1)	
    FEX=FEX0*A*K1F+FEX2*A*(X1+L)/RR2-FEX1*A*(X1-L)/RR1
!------------------------------------------
!------------计算Ey频率域响应--------------
	FEY=FEX1*RTHIP(1)*B*Y1/RR1-FEX2*RTHIP(1)*B*Y1/RR2
!------------------------------------------
!------------计算Hy频率域响应--------------
	CALL HY_F1(X1,Y1,L,F,FHY0)
	CALL HY_F2(X1,Y1,L,F,RR2,FHY2)
	CALL HY_F2(X1,Y1,L,F,RR1,FHY1)
	FHY=-FHY0*B+FHY1*B*(X1-L)/RR1-FHY2*B*(X1+L)/RR2    
!------------------------------------------
!-------------计算Hx频率域响应-------------
	FHX=B*Y1/RR2*FHY2-B*Y1/RR1*FHY1
!------------------------------------------
!---------------计算HZ频率域响应-----------
	CALL HZ_F1(X1,Y1,L,F,FHZ0)
	FHZ=B*FHZ0
!--------------------------------------------
	DEALLOCATE(RTHIP) 
	RETURN
	END SUBROUTINE
!####################################################################################	
!	        EX_F1和EX_F2是计算Ex的                  *
!**************************************************
	SUBROUTINE EX_F1(X1,Y1,L,F,FEX0)
    INTEGER::I,J
	REAL*8 :: DELT,R,X1,Y1,F,L,M,U  
	COMPLEX*16 :: C0,FEX0	
	DELT=DLOG(10.D0)/10.D0
	FEX0=(0.D0,0.D0)
!----------------------------------------
	DO I=1,NG
	   IF(DABS(X(I)-X1)<1.D-5.AND.Y1==0.0)THEN
	      X1=X1+1.D-3                            !为了计算在源点出的场值
	   END IF
	END DO
!----------------------------------------
	DO I=1,NG
	   C0=(0.0,0.0)	   
	   R=DSQRT((X1-X(I))**2+Y1**2)
	   DO J=1,NH0
	      M=DEXP((J-151)*DELT)/R	      
	      C0=C0+F1(M,F)*H0(J)
	   END DO
	   C0=1.D0/R*C0
	   FEX0=FEX0+W(I)*C0
	END DO	
	END SUBROUTINE
!**********************************************
	SUBROUTINE EX_F2(X1,Y1,L,F,R,FEX1)
    INTEGER::I
	REAL*8 :: X1,Y1,L,F,DELT,R,M
	COMPLEX*16 :: FEX1	
	DELT=DLOG(10.D0)/10.D0
	FEX1=(0.D0,0.D0)		
	DO I=1,NH1
	   M=DEXP((I-151)*DELT)/R	   
	   FEX1=FEX1+F2(M,F)*H1(I)
	END DO
	FEX1=1.D0/R*FEX1
	END	SUBROUTINE
!*************************************************************
!	        HY_F1和HY_F2是计算HY的                  *
!**************************************************
	SUBROUTINE HY_F1(X1,Y1,L,F,FHY0)
    INTEGER::I,J
	REAL*8 :: DELT,R,X1,Y1,F,L,M  
	COMPLEX*16 :: C0,FHY0
	DELT=DLOG(10.D0)/10.D0
	FHY0=(0.D0,0.D0)
!----------------------------------------
	DO I=1,NG
	   IF(DABS(X(I)-X1)<1.D-5.AND.Y1<1.D-5)THEN
	      X1=X1+1.D-3                            !为了计算在源点出的场值
	   END IF
	END DO
!----------------------------------------
	DO I=1,NG
	   C0=(0.0,0.0)	   
	   R=DSQRT((X1-X(I))**2+Y1**2)
	   DO J=1,NH0
	      M=DEXP((J-151)*DELT)/R	      
	      C0=C0+F5(M,F)*H0(J)
	   END DO
	   C0=1.D0/R*C0
	   FHY0=FHY0+W(I)*C0
	END DO	
	END	SUBROUTINE
!**********************************************
	SUBROUTINE HY_F2(X1,Y1,L,F,R,FHY1)
    INTEGER::I
	REAL*8 :: X1,Y1,L,F,DELT,R,M
	COMPLEX*16 :: FHY1	
	DELT=DLOG(10.D0)/10.D0
	FHY1=(0.D0,0.D0)		
	DO I=1,NH1
	   M=DEXP((I-151)*DELT)/R	   
	   FHY1=FHY1+F1(M,F)*H1(I)
	END DO
	FHY1=1.D0/R*FHY1
	END	SUBROUTINE
!*************************************************************
!           HZ_F1是计算HZ的             *
!*******************************************
    SUBROUTINE HZ_F1(X1,Y1,L,F,FHZ0)
    INTEGER:: I,J
	REAL*8 :: X1,Y1,L,F,DELT,R,M,SIN
	COMPLEX*16 :: FHZ0,C0	   
	DELT=DLOG(10.D0)/10.D0	
	FHZ0=(0.D0,0.D0)
!----------------------------------------
	DO I=1,NG
	   IF(DABS(X(I)-X1)<1.D-5.AND.Y1==0.0)THEN
	      X1=X1+1.D-3                            !为了计算在源点出的场值
	   END IF
	END DO
!----------------------------------------
	DO I=1,NG
	   C0=(0.0,0.0)
	   R=DSQRT((X1-X(I))**2+Y1**2)
	   SIN=Y1/R
	   DO J=1,NH1
	      M=DEXP((J-151)*DELT)/R	      
	      C0=C0+SIN*F4(M,F)*H1(J)
	   END DO
	   C0=1.D0/R*C0
	   FHZ0=FHZ0+W(I)*C0
	END DO
	END SUBROUTINE
!####################################################################################	
!	             核函数                     *
!**********************************************
	COMPLEX*16 FUNCTION F1(M,F)
	REAL*8 :: M,F
	COMPLEX*16 :: N1,K1F,R1,R2

	CALL RR(F,M,R1,R2)
	K1F=-(0,1)*2*PI*F*MIU0/RTHIP(1)
	N1=CDSQRT(M**2+K1F)
	F1=M/(M+N1/R1)
	END FUNCTION
!**********************************************
	COMPLEX*16 FUNCTION F2(M,F)
	REAL*8 :: M,F,U
	COMPLEX*16 :: N1,K1F,R1,R2
	
	CALL RR(F,M,R1,R2)
	K1F=-(0.D0,1.D0)*2*PI*F*MIU0/RTHIP(1)
	N1=CDSQRT(M**2+K1F)
	F2=N1/R2-K1F/(M+N1/R1)
	END FUNCTION
!**********************************************
	COMPLEX*16 FUNCTION F4(M,F)
	REAL*8 :: M,F,U
	COMPLEX*16 :: N1,K1F,R1,R2
	
	CALL RR(F,M,R1,R2)
	K1F=-(0.,1.)*2*PI*F*MIU0/RTHIP(1)
	N1=CDSQRT(M**2+K1F)
	F4=M*M/(M+N1/R1)
	END	FUNCTION
!**********************************************
	COMPLEX*16 FUNCTION F5(M,F)
	REAL*8 :: M,F
	COMPLEX*16 :: N1,K1F,R1,R2

	CALL RR(F,M,R1,R2)
	K1F=-(0,1)*2*PI*F*MIU0/RTHIP(1)
	N1=CDSQRT(M**2+K1F)
	F5=N1/R1*M/(M+N1/R1)
	END	FUNCTION		
!####################################################################################
!*******************************************************************
!  下面的子程序R（）是用来计算R1（对应着R*）和R2（对应着R*上―）   !                           
!*******************************************************************
!	上面的各个参数：F是频率，M是贝塞尔积分变量m，N是层数）         *
!	RTH(100)是各层电阻率,H(100)是各层厚度	                       *
!	U(N)是各层的n,根号下m的平方加上k的平方，X,Y,Z,W,S都是中间变量*
!	最下面的均匀半空间的R1,R2是1                                   *
!*******************************************************************
	SUBROUTINE RR(F,M,R1,R2)
    INTEGER::I
	COMPLEX*16 :: X,Y,Z,U(N),W,R1,R2,CTAN,S
	REAL*8 :: M,F
	R1=(1.D0,0.D0)
	R2=(1.D0,0.D0)
!	101循环是为了计算各层的n
	DO 101 I=1,N
	    U(I)=FU(M,F,RTHIP(I))
101	CONTINUE
!	102循环式计算最后的R1和R2结果
	DO 102 I=N-1,1,-1
	    W=U(I)/U(I+1)
		X=W*R1
		Y=W*RTHIP(I)/RTHIP(I+1)*R2
		Z=U(I)*H(I)
	    S=CDEXP(-2*Z)
		R1=((1.0,0.0)+CTH(S)*X)/(CTH(S)+X)
		R2=((1.0,0.0)+CTH(S)*Y)/(CTH(S)+Y)
102	CONTINUE
	END SUBROUTINE
!********************************************************************************
!	下面的函数是用于计算双曲余弦的
	COMPLEX*16 FUNCTION CTH(D)	
	COMPLEX*16 :: D
      IF(CDABS(D-1.0)<1.D-20)THEN
          CTH=(1.D50,0.0)
      ELSE
          CTH=((1.0,0.0)+D)/((1.0,0.0)-D)
      END IF          
	END FUNCTION
!********************************************************************************
!	FU(A,B,C)函数是用来计算n的函数
	COMPLEX*16 FUNCTION FU(A,B,C)
	REAL*8 :: A,B
	COMPLEX*16 :: C  !~~~~~~~~~~~~~~~~~~~~~~
	FU=CDSQRT(A*A-(0.0,1.0)*7.89568E-6*B/C)
    END FUNCTION    
END MODULE
!*********************************************************************************
!=================================================================================
!    以上部分为模块定义
!=================================================================================
!*********************************************************************************





!*********************************************************************************
!=================================================================================
!    接下来为主程序部分
!=================================================================================
!*********************************************************************************
PROGRAM MAIN
!=============================================
  USE FREQUENCY_FORWARD
!=============================================
  IMPLICIT NONE
  INTEGER::I
  !---------------------------------------模型参数
  REAL*8::AB,I0,X1,Y1,XS,YS
  !---------------------------------------频率域参数
  integer,parameter::nfre=201   
  REAL*8,ALLOCATABLE::F(:)
  COMPLEX*16,ALLOCATABLE::EX_F(:),EY_F(:),EZ_F(:),HX_F(:),HY_F(:),HZ_F(:) 
  !----------------------------------------时间域参数
  integer,parameter::ntime=81
  real*8,allocatable::t(:)  
  real*8,allocatable::EX_STEP(:),EY_STEP(:),HX_STEP(:),HY_STEP(:),HZ_STEP(:)
  real*8,allocatable::DEXDT_STEP(:),DEYDT_STEP(:),DHXDT_STEP(:),DHYDT_STEP(:),DHZDT_STEP(:)
  CHARACTER(100) :: FILE_IN
  !=======================================================================================
  WRITE(*,*) 
  WRITE(*,*)  
  WRITE(*,*)"   ==================================================================="
  WRITE(*,*)"   =============     这是1D TEM正演程序      ========================="
  WRITE(*,*)"   ==================================================================="
  WRITE(*,*) 
  WRITE(*,"(A,$)")"   请输入模型文件名:"
  READ(*,*)FILE_IN
  !----------------------------------------
  OPEN(1,FILE=FILE_IN)
  READ(1,*)N        
  ALLOCATE(H(N),RTH(N),MM(N),CC(N),TAO(N))   !模型参数 ~~
  ALLOCATE(F(NFRE),EX_F(NFRE),EY_F(NFRE),EZ_F(NFRE),HX_F(NFRE),HY_F(NFRE),HZ_F(NFRE)) !频率域响应
  allocate(t(ntime),EX_STEP(ntime),EY_STEP(ntime),HX_STEP(ntime),HY_STEP(ntime),HZ_STEP(ntime))!时间参数/阶跃响应
  allocate(DEXDT_STEP(ntime),DEYDT_STEP(ntime),DHXDT_STEP(ntime),DHYDT_STEP(ntime),DHZDT_STEP(ntime)) !脉冲响应
  !--------------------------------------------!读取模型参数
  write(*,*)'---------------------读取模型参数--------------------'  
  DO I=1,N
  READ(1,*)H(I),RTH(I),MM(I),CC(I),TAO(I)  !!~~~
  END DO
  READ(1,*)X1,Y1   !接收点坐标
  READ(1,*)XS,YS   !源坐标
  READ(1,*)AB,I0   !导线长度，电流强度
  close(1)
  !-------------------------------------------
  write(*,*)'----------------开始计算频率域电磁响应----------------'
  call data_fre_time(f,nfre,t,ntime)
! CALL FILTER   !这里舍去直接使用 HANKERL 模块
  CALL FORWARD(X1,Y1,XS,YS,AB,I0,F,NFRE,EX_F,EY_F,HX_F,HY_F,HZ_F)
  write(*,*)'----------------频率域电磁响应计算完毕----------------'
  write(*,*)'-------------------开始计算阶跃和脉冲响应-------------------'
  do i=1,ntime
      write(*,"(8x,'T=',f15.6)")t(i)
      CALL STEP_RESPONGSE(F,NFRE,t(i),EX_F,EY_F,HX_F,HY_F,HZ_F,        &
     		EX_STEP(i),EY_STEP(i),HX_STEP(i),HY_STEP(i),HZ_STEP(i),    &
            DEXDT_STEP(i),DEYDT_STEP(i),DHXDT_STEP(i),DHYDT_STEP(i),DHZDT_STEP(i))
  end do
  write(*,*)'-------------------阶跃响应计算完毕------------------'  
  !-----------------------------------------------------------------------输出频率约响应
    OPEN(3,FILE='Frequency_domain_Response.DAT')
    WRITE(3,700)
    DO I=1,NFRE
     WRITE(3,600)F(I),DBLE(EX_F(I)),DIMAG(EX_F(I)),DBLE(EY_F(I)),DIMAG(EY_F(I)),   &
	 DBLE(EZ_F(I)),DIMAG(EZ_F(I)),DBLE(HX_F(I)),DIMAG(HX_F(I)),DBLE(HY_F(I)),DIMAG(HY_F(I)),   &
	 DBLE(HZ_F(I)),DIMAG(HZ_F(I))
  END DO
600 FORMAT(100(5X,D20.14))
700 FORMAT(15X,'F',23X,'REX',22X,'IMEX',21X,'REY',21X,'IMEY',21X,'REZ',21X,'IMEZ',   &
           21X,'RHX',21X,'IMHX',22X,'RHY',22X,'IMHY',22X,'RHZ',22X,'IMHZ')
    close(3)
  !------------------------------------------------------------------------
    OPEN(4,FILE='Time_domain_Response.DAT')  
    write(4,800)
    do i=1,ntime
        !write(4,600)t(i),DABS(EX_STEP(i)),DABS(EY_STEP(i)),DABS(HX_STEP(i)),DABS(HY_STEP(i)),DABS(HZ_STEP(i)),   &
        !DABS(DEXDT_STEP(i)),DABS(DEYDT_STEP(i)),DABS(DHXDT_STEP(i)),DABS(DHYDT_STEP(i)),DABS(DHZDT_STEP(i))
        write(4,600)t(i),EX_STEP(i),EY_STEP(i),HX_STEP(i),HY_STEP(i),HZ_STEP(i),   &
                    DEXDT_STEP(i),DEYDT_STEP(i),DHXDT_STEP(i),DHYDT_STEP(i),DHZDT_STEP(i)
    end do
800 FORMAT(15X,'T',23X,'Ex',21X,'Ey',21X,'Hx',21X,'Hy',22X,'Hz',22X,'dEx/dt',22X,'dEy/dt',22X,'dHx/dt',22X,'dHy/dt',22X,'dHz/dt')    
    close(4)

!=====================================================================================
    WRITE(*,*)"   ==================================================================="
    WRITE(*,*)"   =============     TEM正演成功结束！      =========================="
    WRITE(*,*)
    WRITE(*,*)"   =============   按下Enter键结束程序……  =========================="
    WRITE(*,*)"   ==================================================================="
	PAUSE
!=====================================================================================
END PROGRAM MAIN


!=====================================================================================
!    功能说明:
!=====================================================================================
subroutine data_fre_time(f,nfre,t,ntime)
    real*8::f(nfre),t(ntime)
    f=(/  &
         1.00000000E-08 , 1.25892541E-08 , 1.58489319E-08 , 1.99526231E-08 , 2.51188643E-08 , &
         3.16227766E-08 , 3.98107171E-08 , 5.01187234E-08 , 6.30957344E-08 , 7.94328235E-08 , &
         1.00000000E-07 , 1.25892541E-07 , 1.58489319E-07 , 1.99526231E-07 , 2.51188643E-07 , &
         3.16227766E-07 , 3.98107171E-07 , 5.01187234E-07 , 6.30957344E-07 , 7.94328235E-07 , &
         1.00000000E-06 , 1.25892541E-06 , 1.58489319E-06 , 1.99526231E-06 , 2.51188643E-06 , &
         3.16227766E-06 , 3.98107171E-06 , 5.01187234E-06 , 6.30957344E-06 , 7.94328235E-06 , &
         1.00000000E-05 , 1.25892541E-05 , 1.58489319E-05 , 1.99526231E-05 , 2.51188643E-05 , &
         3.16227766E-05 , 3.98107171E-05 , 5.01187234E-05 , 6.30957344E-05 , 7.94328235E-05 , &
         1.00000000E-04 , 1.25892541E-04 , 1.58489319E-04 , 1.99526231E-04 , 2.51188643E-04 , &
         3.16227766E-04 , 3.98107171E-04 , 5.01187234E-04 , 6.30957344E-04 , 7.94328235E-04 , &
         1.00000000E-03 , 1.25892541E-03 , 1.58489319E-03 , 1.99526231E-03 , 2.51188643E-03 , &
         3.16227766E-03 , 3.98107171E-03 , 5.01187234E-03 , 6.30957344E-03 , 7.94328235E-03 , &
         1.00000000E-02 , 1.25892541E-02 , 1.58489319E-02 , 1.99526231E-02 , 2.51188643E-02 , &
         3.16227766E-02 , 3.98107171E-02 , 5.01187234E-02 , 6.30957344E-02 , 7.94328235E-02 , &
         1.00000000E-01 , 1.25892541E-01 , 1.58489319E-01 , 1.99526231E-01 , 2.51188643E-01 , &
         3.16227766E-01 , 3.98107171E-01 , 5.01187234E-01 , 6.30957344E-01 , 7.94328235E-01 , &
         1.00000000E+00 , 1.25892541E+00 , 1.58489319E+00 , 1.99526231E+00 , 2.51188643E+00 , &
         3.16227766E+00 , 3.98107171E+00 , 5.01187234E+00 , 6.30957344E+00 , 7.94328235E+00 , &
         1.00000000E+01 , 1.25892541E+01 , 1.58489319E+01 , 1.99526231E+01 , 2.51188643E+01 , &
         3.16227766E+01 , 3.98107171E+01 , 5.01187234E+01 , 6.30957344E+01 , 7.94328235E+01 , &
         1.00000000E+02 , 1.25892541E+02 , 1.58489319E+02 , 1.99526231E+02 , 2.51188643E+02 , &
         3.16227766E+02 , 3.98107171E+02 , 5.01187234E+02 , 6.30957344E+02 , 7.94328235E+02 , &
         1.00000000E+03 , 1.25892541E+03 , 1.58489319E+03 , 1.99526231E+03 , 2.51188643E+03 , &
         3.16227766E+03 , 3.98107171E+03 , 5.01187234E+03 , 6.30957344E+03 , 7.94328235E+03 , &
         1.00000000E+04 , 1.25892541E+04 , 1.58489319E+04 , 1.99526231E+04 , 2.51188643E+04 , &
         3.16227766E+04 , 3.98107171E+04 , 5.01187234E+04 , 6.30957344E+04 , 7.94328235E+04 , &
         1.00000000E+05 , 1.25892541E+05 , 1.58489319E+05 , 1.99526231E+05 , 2.51188643E+05 , &
         3.16227766E+05 , 3.98107171E+05 , 5.01187234E+05 , 6.30957344E+05 , 7.94328235E+05 , &
         1.00000000E+06 , 1.25892541E+06 , 1.58489319E+06 , 1.99526231E+06 , 2.51188643E+06 , &
         3.16227766E+06 , 3.98107171E+06 , 5.01187234E+06 , 6.30957344E+06 , 7.94328235E+06 , &
         1.00000000E+07 , 1.25892541E+07 , 1.58489319E+07 , 1.99526231E+07 , 2.51188643E+07 , &
         3.16227766E+07 , 3.98107171E+07 , 5.01187234E+07 , 6.30957344E+07 , 7.94328235E+07 , &
         1.00000000E+08 , 1.25892541E+08 , 1.58489319E+08 , 1.99526231E+08 , 2.51188643E+08 , &
         3.16227766E+08 , 3.98107171E+08 , 5.01187234E+08 , 6.30957344E+08 , 7.94328235E+08 , &
         1.00000000E+09 , 1.25892541E+09 , 1.58489319E+09 , 1.99526231E+09 , 2.51188643E+09 , &
         3.16227766E+09 , 3.98107171E+09 , 5.01187234E+09 , 6.30957344E+09 , 7.94328235E+09 , &
         1.00000000E+10 , 1.25892541E+10 , 1.58489319E+10 , 1.99526231E+10 , 2.51188643E+10 , &
         3.16227766E+10 , 3.98107171E+10 , 5.01187234E+10 , 6.30957344E+10 , 7.94328235E+10 , &
         1.00000000E+11 , 1.25892541E+11 , 1.58489319E+11 , 1.99526231E+11 , 2.51188643E+11 , &
         3.16227766E+11 , 3.98107171E+11 , 5.01187234E+11 , 6.30957344E+11 , 7.94328235E+11 , &
         1.00000000E+12/)
    t=(/ &
         1.00000000E-08 , 1.25892541E-08 , 1.58489319E-08 , 1.99526231E-08 , 2.51188643E-08 , &
         3.16227766E-08 , 3.98107171E-08 , 5.01187234E-08 , 6.30957344E-08 , 7.94328235E-08 , &
         1.00000000E-07 , 1.25892541E-07 , 1.58489319E-07 , 1.99526231E-07 , 2.51188643E-07 , &
         3.16227766E-07 , 3.98107171E-07 , 5.01187234E-07 , 6.30957344E-07 , 7.94328235E-07 , &
         1.00000000E-06 , 1.25892541E-06 , 1.58489319E-06 , 1.99526231E-06 , 2.51188643E-06 , &
         3.16227766E-06 , 3.98107171E-06 , 5.01187234E-06 , 6.30957344E-06 , 7.94328235E-06 , &
         1.00000000E-05 , 1.25892541E-05 , 1.58489319E-05 , 1.99526231E-05 , 2.51188643E-05 , &
         3.16227766E-05 , 3.98107171E-05 , 5.01187234E-05 , 6.30957344E-05 , 7.94328235E-05 , &
         1.00000000E-04 , 1.25892541E-04 , 1.58489319E-04 , 1.99526231E-04 , 2.51188643E-04 , &
         3.16227766E-04 , 3.98107171E-04 , 5.01187234E-04 , 6.30957344E-04 , 7.94328235E-04 , &
         1.00000000E-03 , 1.25892541E-03 , 1.58489319E-03 , 1.99526231E-03 , 2.51188643E-03 , &
         3.16227766E-03 , 3.98107171E-03 , 5.01187234E-03 , 6.30957344E-03 , 7.94328235E-03 , &
         1.00000000E-02 , 1.25892541E-02 , 1.58489319E-02 , 1.99526231E-02 , 2.51188643E-02 , &
         3.16227766E-02 , 3.98107171E-02 , 5.01187234E-02 , 6.30957344E-02 , 7.94328235E-02 , &
         1.00000000E-01 , 1.25892541E-01 , 1.58489319E-01 , 1.99526231E-01 , 2.51188643E-01 , &
         3.16227766E-01 , 3.98107171E-01 , 5.01187234E-01 , 6.30957344E-01 , 7.94328235E-01 , &
         1.00000000E+00/) 
end subroutine



!=====================================================================================
!    功能说明:
!=====================================================================================
!计算时间域阶跃响应
	SUBROUTINE STEP_RESPONGSE(F,NFRE,IT,EX_F,EY_F,HX_F,HY_F,HZ_F,&
     		EX_STEP,EY_STEP,HX_STEP,HY_STEP,HZ_STEP,&
            DEXDT_STEP,DEYDT_STEP,DHXDT_STEP,DHYDT_STEP,DHZDT_STEP)
    USE HANKERL
    IMPLICIT NONE   
!************************************************************************************
!	F为输入参数，给出所要计算的频率数组                                             *
!	NFRE为输入参数，是F数组的元素个数                                               *
!	IT为输入参数，为采样时间                                                        *
!	H05为输入参数，是0.5阶汉克尔变换的系数                                          *
!	RFEXR,RFHYR,RFHZR为输入参数，是频率域响应的实部，每个数组有NFRE个元素           *
!	EX_STEP,EY_STEP,HX_STEP,HY_STEP,HZ_STEP为输出参数，是长导线瞬变电磁法的时间域响应 *
!	DELT是采样间隔，ln(10)/10                                                       *
!	F1(NH05)是插值点的频率                                                           *
!	NH05是0.5阶汉克尔变换系数的个数，也就是所要插值点的个数                          *
!	NC2是为了方便表示数组而引入的参数                                               *
!	C是时间域阶跃响应前面的系数                                                     *
!	S1,S4,S5是中间变量                                                              *
!************************************************************************************				
	INTEGER:: NFRE
    INTEGER::II,J,K
	INTEGER,PARAMETER::NC2=80
    COMPLEX*16::EX_F(NFRE),EY_F(NFRE),HX_F(NFRE),HY_F(NFRE),HZ_F(NFRE)
	REAL*8:: F(NFRE),IT,F1(NH05),OMIGA(NH05)
    REAL*8:: RFEX(NFRE),RFEY(NFRE),RFHX(NFRE),RFHY(NFRE),RFHZ(NFRE)
    REAL*8:: IFEX(NFRE),IFEY(NFRE),IFHX(NFRE),IFHY(NFRE),IFHZ(NFRE)
    REAL*8:: EX_STEP,EY_STEP,HX_STEP,HY_STEP,HZ_STEP
    REAL*8:: DEXDT_STEP,DEYDT_STEP,DHXDT_STEP,DHYDT_STEP,DHZDT_STEP
    REAL*8:: RFEX1(NH05),RFEY1(NH05),RFHX1(NH05),RFHY1(NH05),RFHZ1(NH05)
    REAL*8:: IFEX1(NH05),IFEY1(NH05),IFHX1(NH05),IFHY1(NH05),IFHZ1(NH05)
    REAL*8:: C,DELT
    REAL*8::S1,S2,S3,S4,S5,S6,S7,S8,S9,S10
	REAL*8:: Y1(NFRE)
	DELT=DLOG(10.D0)/10.D0
    RFEX=DBLE(EX_F)
    RFEY=DBLE(EY_F)
    RFHX=DBLE(HX_F)
    RFHY=DBLE(HY_F)
    RFHZ=DBLE(HZ_F)
    IFEX=DIMAG(EX_F)
    IFEY=DIMAG(EY_F)
    IFHX=DIMAG(HX_F)
    IFHY=DIMAG(HY_F)
    IFHZ=DIMAG(HZ_F)
	S1=0.D0
	S2=0.D0
	S3=0.D0
	S4=0.D0
	S5=0.D0
	S6=0.D0
	S7=0.D0
	S8=0.D0
	S9=0.D0    
	S10=0.D0    
!------------------------------------------------------------------
!	计算时间域阶跃响应
!	402循环是为了计算汉克尔变换不同的n所对应的频率，并进行插值，最后得到时间域介于响应
	DO 402 J=1,NH05
	    OMIGA(J)=DEXP(DBLE(J-NH05+NC2)*DELT)/IT
	    F1(J)=OMIGA(J)/2.D0/PI
402	CONTINUE
	DO 410 II=1,NH05                                           !  这三次样条插值的方法  
	    CALL SPLINE(F,RFEX,NFRE,0.D0,0.D0,Y1)                                   
	    CALL SPLINT(F,RFEX,Y1,NFRE,F1(II),RFEX1(II))  
		CALL SPLINE(F,RFEY,NFRE,0.D0,0.D0,Y1)                                                                             
		CALL SPLINT(F,RFEY,Y1,NFRE,F1(II),RFEY1(II))                                                                          
		CALL SPLINE(F,RFHX,NFRE,0.D0,0.D0,Y1)                                                                            
		CALL SPLINT(F,RFHX,Y1,NFRE,F1(II),RFHX1(II))        
	    CALL SPLINE(F,RFHY,NFRE,0.D0,0.D0,Y1)                                 
	    CALL SPLINT(F,RFHY,Y1,NFRE,F1(II),RFHY1(II))                           
	    CALL SPLINE(F,RFHZ,NFRE,0.D0,0.D0,Y1)                                  
	    CALL SPLINT(F,RFHZ,Y1,NFRE,F1(II),RFHZ1(II))
        CALL SPLINE(F,IFEX,NFRE,0.D0,0.D0,Y1)                                   
	    CALL SPLINT(F,IFEX,Y1,NFRE,F1(II),IFEX1(II))  
		CALL SPLINE(F,IFEY,NFRE,0.D0,0.D0,Y1)                                                                             
		CALL SPLINT(F,IFEY,Y1,NFRE,F1(II),IFEY1(II))                                                                          
		CALL SPLINE(F,IFHX,NFRE,0.D0,0.D0,Y1)                                                                            
		CALL SPLINT(F,IFHX,Y1,NFRE,F1(II),IFHX1(II))        
	    CALL SPLINE(F,IFHY,NFRE,0.D0,0.D0,Y1)                                 
	    CALL SPLINT(F,IFHY,Y1,NFRE,F1(II),IFHY1(II))         
	    CALL SPLINE(F,IFHZ,NFRE,0.D0,0.D0,Y1)                                   
	    CALL SPLINT(F,IFHZ,Y1,NFRE,F1(II),IFHZ1(II))           
410	CONTINUE
!	403循环是为了计算F（n*delt)*H0.5(n)的累加和
	   DO 403 K=1,NH05
	      S1=S1+RFEX1(K)/DSQRT(OMIGA(K))*H05(K)
          S2=S2+RFEY1(K)/DSQRT(OMIGA(K))*H05(K)
          S3=S3+RFHX1(K)/DSQRT(OMIGA(K))*H05(K)
	      S4=S4+RFHY1(K)/DSQRT(OMIGA(K))*H05(K)
		  S5=S5+RFHZ1(K)/DSQRT(OMIGA(K))*H05(K)	      
	      S6=S6+IFEX1(K)*DSQRT(OMIGA(K))*H05(K)
		  S7=S7+IFEY1(K)*DSQRT(OMIGA(K))*H05(K)
          S8=S8+IFHX1(K)*DSQRT(OMIGA(K))*H05(K)
          S9=S9+IFHY1(K)*DSQRT(OMIGA(K))*H05(K)
          S10=S10+IFHZ1(K)*DSQRT(OMIGA(K))*H05(K)
403	   CONTINUE
	   C=-DSQRT(2.D0/PI/IT)
       EX_STEP=C*S1+DBLE(EX_F(1))
       EY_STEP=C*S2+DBLE(EY_F(1))
	   HX_STEP=C*S3+DBLE(HX_F(1))       
	   HY_STEP=C*S4+DBLE(HY_F(1))
	   HZ_STEP=C*S5+DBLE(HZ_F(1))
       DEXDT_STEP=-C*S6
       DEYDT_STEP=-C*S7
       DHXDT_STEP=-C*S8
       DHYDT_STEP=-C*S9
	   DHZDT_STEP=-C*S10
END SUBROUTINE



!=====================================================================================
!    功能说明:
!=====================================================================================
!######################################################################################################
!************************************************************************************
!	计算插值函数在节点x1<x2<・・・<xn处的二阶导数值―――――Fortran77手册上的      *
!************************************************************************************
	SUBROUTINE SPLINE(X,Y,N,YP1,YPN,Y2)
!*******************************************************************************
!	X是N个元素的一维实型数组，输入参数，存放样条节点：x1<x2<・・・<xn          *
!	Y是N个元素的一维实型数组，输入参数，存放节点的函数值                       *
!	N整型变量输入参数，节点个数                                                *
!	YP1，YPNa是实行变量，输入参数，分别存放插值函数在x1和xn点的一阶倒数        *
!			 当这两个量或其中之一大于等于10**30时，子程序自动调用自然样条条件  *
!	Y2是N个元素的一维实型数组，输出参数，输出差值函数在插值接节点的二阶导数值  *
!*******************************************************************************
	PARAMETER (NMAX=10000)
	IMPLICIT REAL*8 (A-H,O-Z)
	REAL*8 X(N),Y(N),Y2(N),U(NMAX)
	IF(YP1.GT.0.99E30)THEN
	   Y2(1)=0
	   U(1)=0
	ELSE
	   Y2(1)=-0.5
	   U(1)=(3.0/(X(2)-X(1)))*((Y(2)-Y(1))/(X(2)-X(1))-YP1)     	 
	END IF
	DO 11 I=2,N-1
	   SIG=(X(I)-X(I-1))/(X(I+1)-X(I-1))
	   P=SIG*Y2(I-1)+2.
	   Y2(I)=(SIG-1.0)/P
	   U(I)=(6.0*((Y(I+1)-Y(I))/(X(I+1)-X(I))-(Y(I)-&
           Y(I-1))/(X(I)-X(I-1)))/(X(I+1)-X(I-1))-SIG*&
           U(I-1))/P
11	CONTINUE
	IF(YPN.GT.0.99E30)THEN
	   QN=0.0
	   UN=0.0
	ELSE
	   QN=0.5
	   UN=(3./(X(N)-X(N-1)))*(YPN-(Y(N)-Y(N-1))/ (X(N)-X(N-1)))        
	END IF
	Y2(N)=(UN-QN*U(N-1))/(QN*Y2(N-1)+1.0)
	DO 12 K=N-1,1,-1
	   Y2(K)=Y2(K)*Y2(K+1)+U(K)
12	CONTINUE
	RETURN
	END
	
	
!************************************************************************
	SUBROUTINE SPLINT(XA,YA,Y2A,N,X,Y)
!***************************************************************************
!	N是整型变量输入参数，节点个数                                          *
!	XA是N个元素的一维实型数组，输入参数，存放样条节点：x1<x2<・・・<xn     *
!	YA是N个元素的一维实型数组，输入参数，存放节点的函数值                  *
!	YA2是N个元素的一维实型数组，输入参数，存放由子程序SPLIN输出的二阶导数值*
!	X实型变量，输入参数，插值点                                            *
!	Y实行变量，输出参数，插值结果                                          *
!***************************************************************************
	IMPLICIT REAL*8 (A-H,O-Z)
	REAL*8 XA(N),YA(N),Y2A(N)
	KLO=1
	KHI=N
!	CONTINUE
IF (X.LT.XA(1)) THEN                        !  当所要插值的点在已知节点范围之外就利用边
   Y=(YA(1)+YA(2)+YA(3)+YA(4)+YA(5))/5.D0   !  界处五点的值求平均来代替所要插的节点出的值
ELSE IF(X.GT.XA(N))THEN
       Y=(YA(N)+YA(N-1)+YA(N-2)+YA(N-3)+YA(N-4))/5.D0
	 ELSE 
1	IF((KHI-KLO).GT.1)THEN
	   K=(KHI+KLO)/2
	   IF(XA(K).GT.X)THEN
	      KHI=K
	   ELSE
	      KLO=K
	   END IF
	   GOTO 1
	END IF
	H=XA(KHI)-XA(KLO)
	IF(H.EQ.0) PAUSE'BED XA INPUT'
	A=(XA(KHI)-X)/H
	B=(X-XA(KLO))/H
	Y=A*YA(KLO)+B*YA(KHI)+((A**3-A)*Y2A(KLO)&
          +(B**3-B)*Y2A(KHI))*(H*2)/6.
	END IF
	RETURN
	END
!######################################################################################################


!=====================================================================================
!    功能说明:
!=====================================================================================
!	下面的函数是为了计算高斯点和权系数
	SUBROUTINE GAULEG(X1,X2,X,W,N)
!	N是整型变量，输入参数，节点数
!	X1是实行变量，输入参数，积分下限
!	X2是实行变量，输入参数，积分上限
!	X是N个变元的一维实型数组，输出参数，存放高斯点
!	W是N个变元的一维实型数组，输出参数，存放高斯求积公式的权系数
	IMPLICIT REAL*8(A-H,O-Z)
	REAL*8 X1,X2,X(N),W(N)
	PARAMETER (EPS=3.D-14)
	M=(N+1)/2
	XM=0.5D0*(X2+X1)
	XL=0.5D0*(X2-X1)
	DO 12 I=1,M
	   Z=DCOS(3.141592654D0*(I-0.25D0)/(N+0.5D0))
1	   CONTINUE
	   P1=1.D0
	   P2=0.D0
	   DO 11 J=1,N
	      P3=P2
	      P2=P1
	      P1=((2.D0*J-1.D0)*Z*P2-(J-1.D0)*P3)/J
11	   CONTINUE
	   PP=N*(Z*P1-P2)/(Z*Z-1.D0) 
	   Z1=Z
	   Z=Z1-P1/PP
	   IF (ABS(Z-Z1).GT.EPS) GOTO 1
	   X(I)=XM-XL*Z
	   X(N+1-I)=XM+XL*Z
	   W(I)=2.D0*XL/((1.D0-Z*Z)*PP*PP)
	   W(N+1-I)=W(I)
12	CONTINUE
	RETURN
	END